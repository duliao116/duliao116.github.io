# 油猴脚本-保存得到课程

## 极客时间

在油猴的脚本搜索里找到了保存极客时间文章的插件：

```javascript
// ==UserScript==
// @name         极客时间专栏文章保存
// @namespace    https://github.com/LazyBug1E0CF
// @version      0.4.2
// @description  在极客时间专栏内容页面增加一个保存按钮，点击后将正文以markdown格式下载保存
// @author       L
// @match        *://time.geekbang.org/column/article/*
// @grant        none
// @require      https://unpkg.com/ajax-hook@1.8.3/dist/ajaxhook.min.js
// @require      https://unpkg.com/showdown/dist/showdown.min.js
// ==/UserScript==

(function() {
    'use strict';

    const KEY_CONTENT = "mdContent";
    const KEY_TITLE = "mdTitle";
    const FILE_TYPE = "application/md";
    const articleRequestUrlRegex = /^https?:\/\/time\.geekbang\.org\/serv\/v\d\/article/;
    const mdService = new showdown.Converter();


    hookAjax({
        //拦截回调
        onreadystatechange:function(xhr){
            //console.log("onreadystatechange called: %O",xhr)
            if (xhr.readyState === 4 && articleRequestUrlRegex.test(xhr.responseURL)) {
                console.log(xhr.response);
                let resJson = JSON.parse(xhr.response);
                let title = resJson.data.article_title;
                let data = resJson.data.article_content;
                const mdContent = mdService.makeMarkdown("<h1>" + title + "</h1>" + data);
                sessionStorage.setItem(KEY_TITLE, title);
                sessionStorage.setItem(KEY_CONTENT, mdContent);

                genSaveBtn();
            }
        }
    });

    const genSaveBtn = () => {
            saveBtn = document.createElement("div");
            saveBtn.id = "save_btn";
            saveBtn.textContent = "存";
            saveBtn.onclick = () => {
                createAndDownloadFile(sessionStorage.getItem(KEY_TITLE) + ".md", sessionStorage.getItem(KEY_CONTENT));
            };
            setSaveBtnStyle(saveBtn);
            document.querySelector("#app").appendChild(saveBtn);
    }

    const setSaveBtnStyle = (saveBtn) => {
        saveBtn.style.position = "fixed";
        saveBtn.style.bottom = "2em";
        saveBtn.style.right = "2em";
        saveBtn.style.borderRadius = "50%";
        saveBtn.style.backgroundColor = "#f6f7f9";
        saveBtn.style.height = "38px";
        saveBtn.style.width = "38px";
        saveBtn.style.textAlign = "center";
        saveBtn.style.lineHeight = "38px";
        saveBtn.style.border = "1px solid #f6f7f9";
        saveBtn.style.cursor = "pointer";
    }

    const createAndDownloadFile = (fileName, content) => {
        let aTag = document.createElement('a');
        let blob = new Blob([content], {type: FILE_TYPE});
        aTag.download = fileName;
        aTag.href = URL.createObjectURL(blob);
        aTag.click();
        URL.revokeObjectURL(blob);
    }
})();
```

## 得到

依照极客时间的脚本修改，做了得到了课程内容保存脚本。

```javascript
// ==UserScript==
// @name         得到课程文章保存
// @namespace    https://github.com/duliao116
// @version      0.0.1
// @description  在得到专栏内容页面增加一个保存按钮，点击后将正文以markdown格式下载保存
// @author       L
// @match        *://www.dedao.cn/course/article*
// @grant        none
// @require      https://unpkg.com/ajax-hook@1.8.3/dist/ajaxhook.min.js
// ==/UserScript==

(function () {
    'use strict';

    const KEY_CONTENT = "mdContent";
    const KEY_TITLE = "mdTitle";
    const FILE_TYPE = "application/md";
    const articleRequestUrlRegex = /^https?:\/\/www\.dedao\.cn\/pc\/ddarticle\/v\d\/article/;

    hookAjax({
        //拦截回调
        onreadystatechange: function (xhr) {
            if (xhr.readyState === 4 && articleRequestUrlRegex.test(xhr.responseURL)) {
                console.log(xhr.response);
                let resJson = JSON.parse(xhr.response);
                let data = resJson.c.content;
                let content = JSON.parse(data);
                let title = content[0].title;

                sessionStorage.setItem(KEY_TITLE, title);
                sessionStorage.setItem(KEY_CONTENT, createMdContent(content));

                genSaveBtn();
            }
        }
    });

    const genSaveBtn = () => {
            saveBtn = document.createElement("div");
            saveBtn.id = "save_btn";
            saveBtn.textContent = "存";
            saveBtn.onclick = () => {
                createAndDownloadFile(sessionStorage.getItem(KEY_TITLE) + ".md", sessionStorage.getItem(KEY_CONTENT));
            };
            setSaveBtnStyle(saveBtn);
            document.querySelector(".iget-pc").appendChild(saveBtn);
    }

    const setSaveBtnStyle = (saveBtn) => {
        saveBtn.style.position = "fixed";
        saveBtn.style.bottom = "2em";
        saveBtn.style.left = "2em";
        saveBtn.style.borderRadius = "50%";
        saveBtn.style.backgroundColor = "#f6f7f9";
        saveBtn.style.height = "38px";
        saveBtn.style.width = "38px";
        saveBtn.style.textAlign = "center";
        saveBtn.style.lineHeight = "38px";
        saveBtn.style.border = "1px solid #f6f7f9";
        saveBtn.style.cursor = "pointer";
    }

    const createAndDownloadFile = (fileName, content) => {
        let aTag = document.createElement('a');
        let blob = new Blob([content], {type: FILE_TYPE});
        aTag.download = fileName;
        aTag.href = URL.createObjectURL(blob);
        aTag.click();
        URL.revokeObjectURL(blob);
    }

    //构造markdown文档
    const createMdContent = (json) => {
        let mdContents = []
        json.forEach(e => {
            if (e.type === 'audio') {
                mdContents.push('# ' + e.title)
            } else if (e.type === 'paragraph') {
                mdContents.push(textRendering(e.contents))
            } else if (e.type === 'image') {
                mdContents.push('![插图](' + e.url + ')')
            } else if (e.type === 'list') {
                e.contents.forEach((item, itemIndex) => {
                    mdContents.push(textRendering(item, e.ordered, itemIndex))
                })
            } else if (e.type === 'hr') {
                mdContents.push('---')
            } else if (e.type === 'tip') {
                mdContents.push(textRendering(e.contents))
            } else if (e.type === 'header') {
                let headerMark = ''
                for (let i = 0; i < e.level; i++) {
                    headerMark = headerMark + '#'
                }
                mdContents.push(headerMark + ' ' + textRendering(e.contents))
            } else if (e.type === 'elite') {
                mdContents.push('---')
                let eliteText = e.text;
                if(!eliteText.endsWith('\n')){
                    eliteText = eliteText + '\n'
                }
                mdContents.push('**划重点**\n```\n' + eliteText + '```')
            } else if(e.type === 'product-item'){
                //忽略
            } else if(e.type === 'blockquote'){
                mdContents.push('> ' + e.text)
            }

            else {
                if (globalThis.window) {
                    alert('不知道的类型:' + e.type)
                } else {
                    console.log('不知道的类型:' + e.type)
                }
            }
        })
        return mdContents.join('\n\n')
    }


    const textRendering = (contents, ordered, index) => {
        let pContents = []
        contents.forEach((p) => {
            if (p.type === 'text') {
                let pText = p.text
                let pContent = pText.content
                if (pText.highlight) {
                    pContent = '***' + pContent + '***'
                }
                if (pText.bold) {
                    pContent = '**' + pContent + '**'
                }
                pContents.push(pContent)
            }
        })
        let result = pContents.join('')
        //有序列表
        if (ordered === true) {
            result = (index + 1) + '. ' + result
        }
        //无序列表
        else if (ordered === false) {
            result = '- ' + result
        }
        return result
    }
})();
```

